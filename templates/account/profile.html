{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile</title>
  <style>
    :root { --ink:#082d52; }

    body {
      font-family: system-ui, sans-serif;
      background:#fafafa;
      margin:0;
    }

    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #082d52;
      color: white;
      padding: 0.75rem 2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .site-name {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .site-name a { color:white; text-decoration:none; }
    .site-name a:hover { color:#29b1f0; }

    .nav-links { display:flex; gap:1.5rem; }
    .nav-links a { color:white; text-decoration:none; }

    .page-container {
      display:flex;
      justify-content:center;
      padding:32px 16px;
    }

    .card {
      position: relative;
      background:white;
      border:1px solid #ddd;
      border-radius:14px;
      padding:32px;
      width:420px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      text-align:left;
    }

    .card-topbar { display:flex; justify-content:flex-end; margin-bottom:8px; }

    .logout-btn {
      background:#e53e3e;
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
    }

    h1 {
      text-align:center;
      font-size:22px;
      margin-bottom:12px;
      overflow-wrap: break-word;  
      word-break: break-word;
    }

    p { margin:10px 0; }

    .avatar-upload { display:flex; justify-content:center; margin-bottom:24px; }

    .avatar-preview {
      width:120px; height:120px;
      border-radius:50%;
      border:3px solid #d1d5db;
      background:#e5e7eb;
      background-size:cover;
      background-position:center;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .avatar-text {
      position:absolute;
      left:0; right:0; bottom:0;
      background:rgba(0,0,0,.7);
      color:white;
      text-align:center;
      padding:6px 0;
      opacity:0;
      transition:.2s;
      border-radius:0 0 50% 50%;
    }
    .avatar-preview:hover .avatar-text { opacity:1; }

    .btn {
      padding:.5rem .9rem;
      border:1px solid var(--ink);
      border-radius:6px;
      cursor:pointer;
      background:white;
    }

    .btn-row { display:flex; gap:.6rem; justify-content:center; margin-top:18px; }

    .edit-link { font-size:.9rem; margin-left:6px; }

    .edit-row {
      margin-top:16px;
      padding:20px 24px;
      display:none;
      flex-direction:column;
      justify-content:center;
      background:white;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(3,7,18,0.25);
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width: min(94%, 520px);
      max-height:80vh;
      overflow:auto;
      z-index:1001;
      box-sizing:border-box;
    }

    .edit-row textarea, .edit-row input {
      width:100%;
      padding:11px 13px;
      border:1px solid #ccc;
      border-radius:6px;
      box-sizing:border-box;
    }

    .edit-row textarea {
      min-height:220px;
      max-height:60vh;
      resize:vertical;
      overflow:auto;
      background:white;
    }

    #modal-backdrop {
      display:none;
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      background:rgba(0,0,0,0.35);
      z-index:1000;
    }

    .btn.primary {
      background:#232d6b;
      color:#fff;
      border:none;
    }

    .interests-form input[type="checkbox"] {
      accent-color: #232d6b;
    }

    .bio-field {
      margin-top:0;
      margin-bottom:10px;
    }

    .bio-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }

    #bio-text {
      margin:0;
      padding:0;
      white-space:pre-wrap;
      line-height:1.5;
      color:#333;
      overflow-wrap: break-word;  
      word-break: break-word;
    }

    #name-text {
      overflow-wrap: break-word;  
      word-break: break-word;
    }

    .muted {
      color:#999;
      font-style:italic;
    }
  </style>
</head>

<body>

<nav>
  <div class="site-name"><a href="/">Hoos Market</a></div>
  <div class="nav-links">
    <a href="{% url 'newpost' %}">New Post</a>
    <a href="{% url 'messaging:inbox' %}">Messages</a>
    <a href="/myaccount/">My Account</a>
    {% if user.is_staff %}
      <a href="{% url 'admin_dashboard' %}">Review content</a>
    {% endif %}
  </div>
</nav>

<div class="page-container">
<div class="card">

  <div class="card-topbar">
    <a href="{% url 'account_logout' %}" class="logout-btn">Log Out</a>
  </div>

  <div class="avatar-upload">
    <form method="post" enctype="multipart/form-data" action="{% url 'profile' %}">
      {% csrf_token %}
      <input type="file" name="image" id="avatar-input" accept="image/*" style="display:none;">
      <label for="avatar-input" class="avatar-preview"
             {% if profile.avatar %}
               style="background-image:url('{{ profile.avatar.url }}')"
             {% endif %}>
        {% if not profile.avatar %}
          <span style="font-size:3rem;opacity:.5;">ðŸ“·</span>
        {% endif %}
        <span class="avatar-text">
          {% if profile.avatar %}Change Picture{% else %}Select Picture{% endif %}
        </span>
      </label>
    </form>
  </div>

  <h1>Hello, {{ profile.nickname|default:user.get_full_name|default:user.username }}!</h1>

  <p><strong>Display name (nickname):</strong>
    <span id="name-text">
      {{ profile.nickname|default:user.get_full_name|default:user.username }}
    </span>
    <a href="#" id="name-edit-toggle" class="edit-link">Edit</a>
  </p>

  <div id="name-edit-row" class="edit-row">
    <input
      type="text"
      id="name-input"
      maxlength="64"
      value="{{ profile.nickname|default:user.get_full_name|default:user.username }}">
    <div class="inline-actions">
      <button class="btn primary" id="name-save">Save</button>
      <button class="btn" id="name-cancel" type="button">Cancel</button>
    </div>
  </div>

  <p><strong>Email:</strong> {{ user.email }}</p>

  <div class="bio-field">
    <div class="bio-header">
      <strong>Bio:</strong>
      <a href="#" id="bio-edit-toggle" class="edit-link">Edit</a>
    </div>
    <p id="bio-text">{% if profile.bio %}{{ profile.bio }}{% else %}<span class="muted">Add a short bio</span>{% endif %}</p>
  </div>

  <div id="bio-edit-row" class="edit-row">
    <textarea id="bio-input" maxlength="500">{% if profile.bio %}{{ profile.bio }}{% endif %}</textarea>
    <div class="inline-actions">
      <button class="btn primary" id="bio-save">Save</button>
      <button class="btn" id="bio-cancel" type="button">Cancel</button>
    </div>
  </div>

  <p><strong>Sustainability interests:</strong></p>
  {% if profile.sustainability_interests %}
  <ul>
    {% for key, label in SUSTAINABILITY_CHOICES %}
      {% if key in profile.sustainability_interests %}
      <li>{{ label }}</li>
      {% endif %}
    {% endfor %}
  </ul>
  {% else %}
    <span class="muted">Add interests to help match you with relevant activities.</span>
  {% endif %}

  <form method="post" action="{% url 'profile' %}" class="interests-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_interests">
    {% for key, label in SUSTAINABILITY_CHOICES %}
      <label><input type="checkbox" name="interests" value="{{ key }}"
        {% if key in profile.sustainability_interests %}checked{% endif %}> {{ label }}</label><br>
    {% endfor %}
    <button type="submit" class="btn primary">Save interests</button>
  </form>

  <p><strong>Status:</strong> {% if user.is_staff %}Admin{% else %}Member{% endif %}</p>

  <div class="btn-row">
    <a class="btn" href="{% url 'messaging:inbox' %}">Messages</a>
    <a class="btn" href="/myposts/">My Posts</a>
    <form method="post" action="{% url 'delete_account' %}" onsubmit="return confirm('Delete account?')">
      {% csrf_token %}
      <button type="submit" class="btn" style="background:#e53e3e;color:white;border:none;">Delete Account</button>
    </form>
  </div>

  <form id="profile-form" method="post" action="{% url 'profile' %}" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="action" id="action-field">
    <input type="hidden" name="nickname" id="nickname-field">
    <textarea name="bio" id="bio-field"></textarea>
  </form>

</div>
</div>

<div id="modal-backdrop"></div>

<script>
function showModal(el){
  document.getElementById('modal-backdrop').style.display='block';
  el.style.display='flex';
}
function hideModal(el){
  document.getElementById('modal-backdrop').style.display='none';
  el.style.display='none';
}

function autoResizeTextarea(el){
  if(!el) return;
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight + 2) + 'px';
}

const nameRow=document.getElementById('name-edit-row');
const nameToggle=document.getElementById('name-edit-toggle');
const nameInput=document.getElementById('name-input');
const nameSave=document.getElementById('name-save');
const nameCancel=document.getElementById('name-cancel');

const bioRow=document.getElementById('bio-edit-row');
const bioToggle=document.getElementById('bio-edit-toggle');
const bioInput=document.getElementById('bio-input');
const bioSave=document.getElementById('bio-save');
const bioCancel=document.getElementById('bio-cancel');

const form=document.getElementById('profile-form');
const actionFld=document.getElementById('action-field');
const nicknameFld=document.getElementById('nickname-field');
const bioFld=document.getElementById('bio-field');

nameToggle.onclick=e=>{ e.preventDefault(); showModal(nameRow); };
nameCancel.onclick=()=>hideModal(nameRow);
nameSave.onclick=e=>{
  e.preventDefault();
  actionFld.value='update_nickname';
  nicknameFld.value = nameInput.value.trim().slice(0, 64);
  form.submit();
};

bioToggle.onclick=e=>{ e.preventDefault(); showModal(bioRow); };
bioCancel.onclick=()=>hideModal(bioRow);
bioSave.onclick=e=>{
  e.preventDefault();
  actionFld.value='update_bio';
  bioFld.value=bioInput.value.trim();
  form.submit();
};

bioInput.addEventListener('input', ()=>autoResizeTextarea(bioInput));
const originalShowModal = showModal;
showModal = function(el){
  originalShowModal(el);
  if(el === bioRow){
    autoResizeTextarea(bioInput);
    setTimeout(()=> bioInput.focus(), 50);
  }
  if(el === nameRow){
    setTimeout(()=> nameInput.focus(), 50);
  }
};

document.getElementById('modal-backdrop').onclick = function(){
  document.querySelectorAll('.edit-row').forEach(r=>r.style.display='none');
  this.style.display='none';
};
</script>

</body>
</html>