<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title|default:"Conversation" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --ink:#082d52; --accent:#29b1f0; --bg:#f8f9fa; --muted:#667085; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:var(--bg)}
    nav{display:flex;align-items:center;justify-content:space-between;background:var(--ink);color:#fff;padding:.75rem 2rem;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .site-name,
    .site-name:visited {font-size:1.5rem;font-weight:700;letter-spacing:.25px;color:#fff;text-decoration:none}
    .site-name:hover {color:var(--accent)}
    .nav-links{display:flex;gap:1.25rem}
    .nav-links a{color:#fff;text-decoration:none}
    .nav-links a:hover{color:var(--accent)}

    .chat{max-width:900px;margin:1.5rem auto;background:#fff;border:1px solid #eef2f7;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;height:72vh}
    .chat-head{display:flex;align-items:center;gap:.75rem;padding:.9rem 1rem;border-bottom:1px solid #eef2f7;background:#fafafa}
    .avatar{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;background:#e8f4ff;color:var(--ink);font-weight:700}
    .name{font-size:1.05rem}
    .sub{font-size:.85rem;color:var(--muted)}
    .messages{padding:1rem;overflow:auto;flex:1;background:#fdfdfd}
    .bubble{max-width:70%;padding:.6rem .8rem;border-radius:14px;margin:.25rem 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .me{background:#e8f4ff;margin-left:auto}
    .them{background:#f3f4f6;margin-right:auto}
    .meta{font-size:.78rem;color:#667085;margin-bottom:.3rem}
    form{display:flex;gap:.5rem;padding:.75rem;border-top:1px solid #eef2f7;background:#fff}
    textarea{flex:1;padding:.6rem;border:1px solid #e5e7eb;border-radius:10px;resize:vertical}
    button[type="submit"]{background:var(--ink);color:#fff;border:none;border-radius:10px;padding:.6rem .9rem;cursor:pointer}
    button[type="submit"]:hover{background:#0a3a6d}
    .back{color:var(--ink);text-decoration:none;border:1px solid var(--ink);border-radius:999px;padding:.25rem .6rem;background:#fff}
    
    @media (prefers-color-scheme: dark) {
      body{ background:#0b1220; color:#e5e7eb; }
      .chat{ background:#0f172a; border-color:#1f2937; }
      .chat-head{ background:#0f172a; border-bottom-color:#1f2937; }
      .messages{ background:#0b1220; }
      .meta{ color:#9aa4b2; }
      .them{ background:#1f2937; }
      .me{ background:#1e3a8a; color:#e0f2fe; }
      textarea{ background:#0b1220; color:#e5e7eb; border-color:#334155; }
      form{ border-top-color:#1f2937; background:#0f172a; }
      .back{ border-color:#334155; color:#e5e7eb; background:#0f172a; }
    }
  </style>
</head>
<body>
  <nav>
    <a href="/dashboard/" class="site-name">Hoos Market</a>
    <div class="nav-links">
      <a href="/posts/">Posts</a>
      <a href="{% url 'messaging:inbox' %}">Messages</a>
      <a href="/myaccount/">My Account</a>
    </div>
  </nav>

  <div class="chat">
    <!-- Conversation header -->
    <div class="chat-head">
      <a class="back" href="{% url 'messaging:inbox' %}">← Inbox</a>
      <div class="avatar">
        {% if thread and thread.is_group %}
          {{ thread.name|default:"?"|first|upper }}
        {% elif other %}
          {% with nick=other.profile.nickname full=other.get_full_name %}
            {% if nick %}
              {{ nick|first|upper }}
            {% elif full %}
              {{ full|first|upper }}
            {% else %}
              {{ other.username|first|upper }}
            {% endif %}
          {% endwith %}
        {% else %}
          ?
        {% endif %}
      </div>
      <div>
        <div class="name">
          {% if thread and thread.is_group %}
            {{ thread.name }}
          {% else %}
            {% if other %}
              {% with nick=other.profile.nickname full=other.get_full_name %}
                {% if nick %}
                  {{ nick }}
                {% elif full %}
                  {{ full }}
                {% else %}
                  {{ other.username }}
                {% endif %}
              {% endwith %}
            {% else %}
              Conversation
            {% endif %}
          {% endif %}
        </div>
        <div class="sub" style="display:flex;flex-wrap:wrap;gap:.25rem;color:#666">
          {% if thread and thread.is_group %}
            {% for p in thread.participants.all %}
              <span style="border:1px solid #eee;border-radius:999px;padding:.05rem .4rem;background:#fafafa">
                {% with nick=p.profile.nickname full=p.get_full_name %}
                  {% if nick %}
                    {{ nick }}
                  {% elif full %}
                    {{ full }}
                  {% else %}
                    {{ p.username }}
                  {% endif %}
                {% endwith %}
                {% if p.id == request.user.id %} (you){% endif %}
              </span>
            {% endfor %}
          {% else %}
            Direct message
          {% endif %}
        </div>
      </div>
    </div>

    <div class="messages">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %}" title="{{ m.created_at|date:'D, M j, Y, g:i A' }}">
          <div class="meta">
            {% if m.sender %}
              {% with nick=m.sender.profile.nickname full=m.sender.get_full_name %}
                {% if nick %}
                  {{ nick }}
                {% elif full %}
                  {{ full }}
                {% else %}
                  {{ m.sender.username }}
                {% endif %}
              {% endwith %}
              {% if m.sender_id == request.user.id %} (you){% endif %}
            {% else %}
              user not found
            {% endif %}
             · {{ m.created_at|date:"M j, H:i" }}
          </div>
          <div>{{ m.text|linebreaksbr }}</div>
        </div>
      {% empty %}
        <p>No messages yet. Say hi!</p>
      {% endfor %}
    </div>

    <form method="post">{% csrf_token %}
      {{ form.text }}
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const box = document.querySelector('.messages');
    if (box) { box.scrollTop = box.scrollHeight; }
  </script>
</body>
</html>
