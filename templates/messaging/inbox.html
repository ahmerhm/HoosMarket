{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ title|default:"Messages" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --ink:#082d52; --accent:#29b1f0; --bg:#f8f9fa; --muted:#667085; }
    * {margin:0;padding:0;box-sizing:border-box}
    body {font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:var(--bg)}
    nav {display:flex;align-items:center;justify-content:space-between;background:var(--ink);color:#fff;padding:.75rem 2rem;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .site-name,
    .site-name:visited {font-size: 1.5rem;font-weight: 700;letter-spacing:.25px;color:#fff;text-decoration:none}
    .site-name:hover {color: var(--accent)}
    .nav-links {display:flex;gap:1.25rem}
    .nav-links a {color:#fff;text-decoration:none}
    .nav-links a:hover {color:var(--accent)}

    .wrap {max-width:900px;margin:1.5rem auto;background:#fff;border:1px solid #eef2f7;border-radius:14px;overflow:hidden}
    .header {display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid #eef2f7}
    .list {list-style:none}
    .item {padding:.9rem 1rem;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:.75rem;transition:background .15s ease}
    .item:hover {background:#fafafa}
    .item a {text-decoration:none;color:var(--ink)}
    .cell {display:flex;align-items:center;gap:.75rem;flex:1;min-width:0}
    .avatar {width:38px;height:38px;border-radius:50%;background:#e8f4ff;color:var(--ink);display:inline-flex;align-items:center;justify-content:center;font-weight:700}
    .title {font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta {color:var(--muted);font-size:.9rem}
    .badge {background:#e02424;color:#fff;border-radius:999px;padding:.1rem .45rem;font-size:.75rem;min-width:1.25rem;text-align:center}
    .empty {padding:1rem 1.25rem;color:var(--muted)}
    .btn {display:inline-block;padding:.5rem .9rem;border-radius:8px;border:1px solid var(--ink);text-decoration:none;background:#fff;cursor:pointer}

    .modal-backdrop {position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal {width:min(720px, 92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
    .modal-head {display:flex;justify-content:space-between;align-items:center;padding:.9rem 1rem;border-bottom:1px solid #eef2f7}
    .modal-body {padding:1rem}
    .close {background:none;border:none;font-size:1.2rem;cursor:pointer}
    
    @media (prefers-color-scheme: dark) {
      body { background:#0b1220; color:#e5e7eb; }
      .wrap { background:#0f172a; border-color:#1f2937; }
      .header { border-bottom-color:#1f2937; }
      .item { border-bottom-color:#1f2937; }
      .item a { color:#e5e7eb; }
      .item:hover { background:#111827; }
      .meta, .empty { color:#9aa4b2; }
      .avatar { background:#1e3a8a; color:#93c5fd; }
      .btn { background:#0f172a; color:#e5e7eb; border-color:#334155; }
      .modal { background:#0f172a; }
      .modal-head { border-bottom-color:#1f2937; color:#e5e7eb; }
      .modal-body { color:#e5e7eb; }
    }
  </style>
</head>
<body>
  <nav>
    <a href="/dashboard/" class="site-name">Hoos Market</a>
    <div class="nav-links">
      <a href="{% url 'newpost' %}">New Post</a>
      <a href="{% url 'messaging:inbox' %}">Messages</a>
      <a href="/myaccount/">My Account</a>
    </div>
  </nav>

  <div class="wrap">
    <div class="header">
      <h2>Inbox</h2>
      <div style="display:flex;gap:.5rem">
        <a href="#" class="btn" id="open-user-picker">Start conversation</a>
        <a class="btn" href="{% url 'messaging:group_new' %}">New group</a>
      </div>
    </div>

    {% if rows %}
      <ul class="list">
        {% for row in rows %}
          <li class="item">
            <div class="cell">
              <div class="avatar">
                {% if row.thread.is_group %}
                  {{ row.thread.name|default:"?"|first|upper }}
                {% elif row.other %}
                  {{ row.other.username|first|upper }}
                {% else %}
                  ?
                {% endif %}
              </div>
              <div style="min-width:0;display:flex;flex-direction:column;gap:.15rem">
                <a class="title" href="{% url 'messaging:thread' row.thread.id %}">
                  {% if row.thread.is_group %}
                    {{ row.thread.name }}
                  {% else %}
                    {% if row.other %}@{{ row.other.username }}{% else %}Conversation{% endif %}
                  {% endif %}
                </a>
                <div class="meta">
                  {% if row.thread.is_group %}
                    {% for p in row.thread.participants.all %}
                      {% if p.id != request.user.id %}
                        @{{ p.username }}{% if not forloop.last %}, {% endif %}
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    Direct message
                  {% endif %}
                </div>
              </div>
            </div>
            {% if row.unread_count > 0 %}
              <span class="badge" title="{{ row.unread_count }} unread">{{ row.unread_count }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty">No conversations yet.</div>
    {% endif %}
  </div>

  <div class="modal-backdrop" id="user-modal">
    <div class="modal">
      <div class="modal-head">
        <strong>Start a conversation</strong>
        <button class="close" id="close-user-picker" aria-label="Close">✕</button>
      </div>

      <div class="modal-body">
        <div style="display:flex;gap:.5rem;margin-bottom:.75rem">
          <form id="user-search-form" style="flex:1">
            <input
              type="text"
              id="user-search-input"
              placeholder="Search username…"
              style="width:100%;padding:.6rem;border:1px solid #ddd;border-radius:6px"
            >
          </form>
          <button id="user-search-button" class="btn" type="button" style="padding:.55rem .9rem;background:#fff">
            Search
          </button>
        </div>

        <div id="user-results">
          <div style="padding:.5rem 0;color:#666">Loading users…</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById('user-modal');
    const resultsEl = document.getElementById('user-results');
    const openBtn = document.getElementById('open-user-picker');
    const closeBtn = document.getElementById('close-user-picker');
    const inputEl = document.getElementById('user-search-input');
    const formEl = document.getElementById('user-search-form');
    const buttonEl = document.getElementById('user-search-button');

    function openModal() {
      modal.style.display = 'flex';
      loadUsers('');
      setTimeout(() => inputEl.focus(), 0);
    }
    function closeModal() {
      modal.style.display = 'none';
    }

    async function loadUsers(q) {
      const url = new URL("{% url 'messaging:user_list' %}", window.location.origin);
      if (q) url.searchParams.set('q', q);
      const res = await fetch(url, { credentials: 'same-origin' });
      const html = await res.text();
      resultsEl.innerHTML = html;
    }

    openBtn.addEventListener('click', (e) => {
      e.preventDefault(); 
      openModal();
    });
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal(); 
    });

    formEl.addEventListener('submit', (e) => {
      e.preventDefault();
      loadUsers(inputEl.value.trim());
      inputEl.focus();
    });

    buttonEl.addEventListener('click', () => {
      loadUsers(inputEl.value.trim());
      inputEl.focus();
    });
  </script>
</body>
</html>
